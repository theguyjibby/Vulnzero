<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VulnZero - Register</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Parkinsans:wght@300..800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>
  <style type="text/tailwindcss">
    @theme {
      --color-clifford: #da373d;
      --color-text: #030303;
      --color-purp: #7257ff;
    }
  </style>
  <body class="bg-white">
    <section class="flex h-screen">
      <div class="basis-2/5 bg-red-400 register-bg"></div>

      <!-- Main -->
      <div class="basis-full flex flex-col justify-center items-center bg-main">
        <h1 class="text-3xl font-semibold">
          Welcome to <span>VulnZero</span> - Register
        </h1>
        <div id="message"></div>
        <form class="flex w-1/3 flex-col my-5" id="registerForm">
          <input
            class="border bg-white border-neutral-400 px-3 py-1.5 rounded-md w-full"
            type="text"
            id="username"
            placeholder="Username"
            required
          />
          <input
            class="border bg-white border-neutral-400 px-3 py-1.5 rounded-md w-full my-5"
            type="email"
            id="email"
            placeholder="Email"
            required
          />
          <input
            type="password"
            class="border bg-white border-neutral-400 px-3 py-1.5 rounded-md w-full"
            id="password"
            placeholder="Password (min 6 characters)"
            required
          />
          <div
            id="spinner"
            hidden
            class="my-2 flex flex-col items-center gap-3 text-purp"
          >
            <div
              class="h-8 w-8 rounded-full border-4 border-purp/30 border-t-purp animate-spin"
            ></div>
            <p class="text-sm font-medium">Logging In...</p>
          </div>
          <button
            class="mt-10 rounded-xl bg-purp px-8 py-3 text-white"
            type="submit"
          >
            Register
          </button>
        </form>
        <p class="color-text">
          Already have an account?
          <button
            class="text-sm text-purp"
            onclick="window.location.href='/templates/login'"
          >
            Login here
          </button>
        </p>
      </div>
    </section>
    <script>
      // Flask server URL - change this if your Flask server runs on a different port
      const API_BASE_URL = "http://127.0.0.1:5000";

      document
        .getElementById("registerForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const spinner = document.getElementById("spinner");
          spinner.hidden = false;

          try {
            const response = await fetch(`${API_BASE_URL}/templates/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ username, email, password }),
            });

            if (!response.ok) {
              // Handle HTTP errors
              spinner.hidden = true;
              if (response.status === 405) {
                throw new Error(
                  "Method not allowed. Please ensure the server is running and the route accepts POST requests."
                );
              }
              const errorData = await response
                .json()
                .catch(() => ({ message: `HTTP ${response.status} Error` }));
              throw new Error(
                errorData.message || `HTTP ${response.status} Error`
              );
            }

            const data = await response.json();
            const messageDiv = document.getElementById("message");
            if (data.status === "true") {
              spinner.hidden = true;
              messageDiv.className = "text-purp text-sm my-2";
              messageDiv.textContent = data.message;
              setTimeout(
                () => (window.location.href = "/templates/login"),
                2000
              );
            } else {
              spinner.hidden = true;
              messageDiv.className = "text-red-500 text-sm my-2";
              messageDiv.textContent = data.message;
            }
          } catch (error) {
            const messageDiv = document.getElementById("message");
            spinner.hidden = true;

            messageDiv.className = "text-red-500 text-sm my-2";
            messageDiv.textContent =
              error.message || "An error occurred. Please try again.";
            console.error("Registration error:", error);
          }
        });
    </script>
  </body>
</html>
