<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VulnZero - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Parkinsans:wght@300..800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./style.css" />
  </head>
  <style type="text/tailwindcss">
    @theme {
      --color-clifford: #da373d;
      --color-text: #030303;
      --color-purp: #7257ff;
    }
  </style>
  <body class="bg-white flex flex-col justify-between p-5 bg-main">
    <nav class="flex justify-between items-center">
      <h1 class="text-3xl font-semibold text-purp">VulnZero</h1>
      <div class="flex gap-4 items-center">
        <h1>Dashboard - Welcome,</h1>
        <button
          class="bg-text text-white px-6 py-2 rounded-lg"
          onclick="window.location.href='/templates/home.html'"
        >
          Logout
        </button>
      </div>
    </nav>

    <div class="scan-form flex flex-col justify-center items-center">
      <form
        class="flex flex-col w-1/3 backdrop-blur-[2px] bg-neutral-300/20 border border-[#ebebeb] rounded-lg p-5"
        id="scanForm"
      >
        <h2 class="text-2xl font-semibold mb-5">New Vulnerability Scan</h2>
        <input
          type="text"
          id="target"
          class="border bg-white border-neutral-400 px-3 py-1.5 rounded-md w-full"
          placeholder="Target (IP or Domain)"
          required
        />
        <select
          class="mt-5 border bg-white border-neutral-400 px-3 py-2 rounded-md w-full"
          id="mode"
        >
          <option value="blue">Blue Team Mode</option>
          <option value="red">Red Team Mode</option>
        </select>
        <button
          class="mt-10 rounded-xl cursor-pointer bg-purp px-8 py-3 text-white"
          type="submit"
        >
          Start Scan
        </button>
      </form>
      <div id="scanMessage" class="mt-10 w-1/3"></div>
      <div class="results w-1/3 mt-10" id="results"></div>
    </div>

    <!-- Results -->

    <script>
      // Flask server URL - change this if your Flask server runs on a different port
      const API_BASE_URL = "http://127.0.0.1:5000";

      document
        .getElementById("scanForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const target = document.getElementById("target").value;
          const mode = document.getElementById("mode").value;
          const messageDiv = document.getElementById("scanMessage");
          const resultsDiv = document.getElementById("results");

          messageDiv.textContent = "Scanning... This may take a few minutes.";
          resultsDiv.innerHTML = "";

          try {
            const response = await fetch(`${API_BASE_URL}/dashboard/targets`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ target, mode }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              console.error("Response error:", response.status, errorText);
              messageDiv.textContent = `Error ${response.status}: ${
                errorText || response.statusText
              }`;
              return;
            }

            const data = await response.json();
            console.log("Scan response:", data);

            if (data.status === "true") {
              messageDiv.textContent = "Scan completed successfully!";
              resultsDiv.innerHTML = `<h3>Scan Results</h3>
                        <p><strong>Target:</strong> ${data.target}</p>
                        <p><strong>IP:</strong> ${data.ip}</p>
                        <p><strong>Subdomains Found:</strong> ${
                          data.subdomains_found
                        }</p>
                        <p><strong>Subdirectories Found:</strong> ${
                          data.subdirectories_found
                        }</p>
                        <p><strong>ZAP Alerts:</strong> ${
                          data.zap_alerts_count
                        }</p>
                        <p><strong>Total Vulnerabilities:</strong> ${
                          data.total_vulnerabilities
                        }</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
              messageDiv.textContent = "Error: " + data.message;
            }
          } catch (error) {
            console.error("Scan error:", error);
            messageDiv.textContent = `Network error: ${error.message}. Make sure the Flask server is running.`;
          }
        });
    </script>
  </body>
</html>
